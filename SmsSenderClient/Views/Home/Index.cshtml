@model MessageViewModel
@{
    ViewData["Title"] = "Send Message";
    var messageSent = TempData["MessageSent"] as bool? ?? false;
}

<div class="min-h-screen flex items-center justify-center bg-slate-50 px-4 pb-12">
    <div class="w-full max-w-md">
        <h1 class="text-2xl font-semibold tracking-tight mb-4 text-center">Надішліть нам повідомлення</h1>

        <form id="sendForm"
              asp-controller="Message"
              asp-action="SendMessage"
              method="post"
              enctype="multipart/form-data"
              class="space-y-4 bg-white/70 backdrop-blur rounded-xl p-4 shadow-sm"
              novalidate>
            @Html.AntiForgeryToken()

            <div asp-validation-summary="ModelOnly" class="text-red-600 text-sm"></div>

            <div class="pb-4 flex flex-col">
                <label asp-for="Name" class="mb-1 text-sm font-medium">Ваше ім'я <span class="text-red-500">*</span></label>
                <input asp-for="Name"
                       type="text"
                       autocomplete="name"
                       class="w-full rounded-lg border border-slate-300 px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                       placeholder="Введіть ваше ім'я" />
                <span asp-validation-for="Name" class="text-red-600 text-xs mt-1"></span>
            </div>
            
            <section class="rounded-lg border border-slate-200 bg-slate-50/80 p-3 sm:p-4">
                <div class="flex items-start gap-3">
                    <div class="shrink-0 mt-0.5">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="currentColor"
                             viewBox="0 0 24 24"
                             class="h-5 w-5 sm:h-6 sm:w-6 text-sky-600"
                             aria-hidden="true">
                            <path fill-rule="evenodd" 
                                  d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm.75 6a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12 10.5a.75.75 0 0 1 .75.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 .75-.75Z" 
                                  clip-rule="evenodd" />
                        </svg>
                        
                    </div>
                    <div class="text-sm leading-relaxed text-slate-900">
                        <p class="font-medium mb-1">Доброго дня, шановні захисник та захисниця!</p>
                        <p>
                            Будь ласка, напишіть у формі нижче, з якими проблемами ви стикаєтесь під час лікування та реабілітації
                            в нашому закладі, щоб ми могли покращити нашу роботу задля вас.
                        </p>
                        <p class="mt-2">
                            Зверніть увагу, що ваше звернення є конфіденційним. Воно буде розглянуте винятково керівництвом
                            та відповідними посадовими особами госпіталю, які допоможуть вам вирішити наявні проблемні питання.
                        </p>
                        <p class="mt-2 italic">
                            Ваша думка, спокій та комфорт є надзвичайно важливими для нас!
                        </p>
                    </div>
                </div>
            </section>
            

            <div class="flex flex-col">
                <label asp-for="Message" class="mb-1 text-sm font-medium">Повідомлення <span class="text-red-500">*</span></label>
                <textarea asp-for="Message"
                          rows="6"
                          maxlength="500"
                          class="w-full resize-y rounded-lg border border-slate-300 px-3 py-2 text-base leading-relaxed focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                          placeholder="Введіть ваше повідомлення"></textarea>
                <div class="flex items-center justify-between mt-1">
                    <span asp-validation-for="Message" class="text-red-600 text-xs"></span>
                    <span id="msgCounter" class="text-xs text-slate-500">0 / 500</span>
                </div>
            </div>
            
            <div class="flex flex-col">
                <label class="mb-1 text-sm font-medium">Додати фото (необов'язково)</label>

                <label for="attachment"
                       class="flex items-center justify-between gap-2 rounded-lg border border-dashed border-slate-300 px-3 py-2 cursor-pointer hover:bg-slate-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M16.5 6.75v7.25a4.75 4.75 0 1 1-9.5 0V7.5a3 3 0 1 1 6 0v6.25a1.25 1.25 0 1 1-2.5 0V8.25h-1.5V13.5a2.75 2.75 0 1 0 5.5 0V7.5a4.5 4.5 0 1 0-9 0v6.5a6.25 6.25 0 1 0 12.5 0V6.75h-1.5z"/>
                    </svg>

                    <span id="attachmentLabel" class="text-sm text-slate-400 truncate">
                        Натисніть, щоб вибрати або зробити фото
                    </span>

                    <span class="ml-auto text-xs text-slate-400">Макс. 5 МБ</span>
                </label>

                <input id="attachment" name="Attachment" type="file" accept="image/*" capture="environment" class="input-hidden" />
                <span asp-validation-for="Attachment" class="text-red-600 text-xs mt-1"></span>

                <div id="previewWrap" class="mt-2 hidden">
                    <img id="previewImg" alt="Preview"
                         class="max-h-48 rounded-lg border border-slate-200 object-contain w-full" />
                </div>

                <span class="text-[10px] text-slate-500 mt-1">Підтримуються: JPG, PNG, WEBP</span>
            </div>
            
            <button id="sendBtn" type="submit"
                    class="w-full rounded-lg bg-sky-600 px-4 py-2.5 mt-8 text-white font-medium active:scale-[0.99] hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500">
                Надіслати
            </button>
        </form>
    </div>
</div>



@if (messageSent)
{
    <div id="sentModal"
         class="fixed inset-0 z-50 flex items-center justify-center px-4"
         role="dialog" aria-modal="true" aria-labelledby="sentTitle">

        <div class="absolute inset-0 bg-black/40" aria-hidden="true"></div>

        <div class="relative w-full max-w-sm rounded-2xl bg-white p-6 shadow-lg">
            <div class="flex items-start gap-3">

                <div class="shrink-0 mt-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                         class="h-8 w-8">
                        <circle cx="12" cy="12" r="10" class="fill-emerald-100"></circle>
                        <path d="M8.5 12.5l2.5 2.5 4.5-5.5"
                              class="stroke-emerald-600" stroke-width="2" fill="none"
                              stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </div>

                <div class="flex-1">
                    <h2 id="sentTitle" class="text-base font-semibold">
                        Повідомлення успішно надіслано
                    </h2>
                    <p class="mt-1 text-sm text-slate-600">
                        Дякуємо! Ми зв'яжемося з вами найближчим часом.
                    </p>
                </div>

                <button type="button" id="sentCloseBtn"
                        class="ml-2 rounded-md p-1 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
                        aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                         viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 
                                 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 
                                 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 
                                 10 4.293 5.707a1 1 0 010-1.414z"
                              clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const modal = document.getElementById('sentModal');
            const closeBtn = document.getElementById('sentCloseBtn');

            const close = () => {
                if (!modal) return;
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
                setTimeout(() => modal.remove(), 5000);
            };

            setTimeout(close, 5000);

            closeBtn?.addEventListener('click', close);

            modal?.addEventListener('click', (e) => {
                if (e.target === modal) close();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') close();
            });
        })();
    </script>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ta = document.querySelector('textarea[name="Message"]');
            const counter = document.getElementById('msgCounter');
            if (ta && counter) {
                const update = () => counter.textContent = `${ta.value.length || 0} / 500`;
                ta.addEventListener('input', update, { passive: true });
                update();
            }


            const form = document.getElementById('sendForm');
            const btn  = document.getElementById('sendBtn');
            if (!form || !btn) return;

            const baseLabel = btn.textContent.trim();
            const frames = ["Надсилання", "Надсилання .", "Надсилання . .", "Надсилання . . ."];
            let i = 0, timer = null, locked = false;

            function startLoading() {
                locked = true;
                btn.disabled = true;
                btn.setAttribute('aria-disabled', 'true');
                btn.setAttribute('aria-busy', 'true');
                btn.classList.add('opacity-60', 'cursor-not-allowed');

                btn.textContent = frames[0];
                i = 0;
                timer = setInterval(() => {
                    i = (i + 1) % frames.length;
                    btn.textContent = frames[i];
                }, 300);
            }

            function stopLoading() {
                if (timer) clearInterval(timer);
                btn.textContent = baseLabel;
                btn.disabled = false;
                btn.removeAttribute('aria-disabled');
                btn.removeAttribute('aria-busy');
                btn.classList.remove('opacity-60', 'cursor-not-allowed');
                locked = false;
            }

            function isValid() {
                if (typeof $ === 'function' && typeof $.fn.valid === 'function') {
                    return $(form).valid();
                }
                return form.checkValidity ? form.checkValidity() : true;
            }

            form.addEventListener('submit', function (e) {
                if (!isValid()) { stopLoading(); return; }
                if (locked) { e.preventDefault(); return; }
                startLoading();
            });

            window.addEventListener('pageshow', function () {
                if (locked) stopLoading();
            });
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
          const fileInput = document.getElementById('attachment');
          const label = document.getElementById('attachmentLabel');
          const previewWrap = document.getElementById('previewWrap');
          const previewImg = document.getElementById('previewImg');
        
          if (!fileInput) return;
        
          fileInput.addEventListener('change', () => {
            const f = fileInput.files && fileInput.files[0];
            if (!f) {
              label.textContent = 'Натисніть, щоб вибрати або зробити фото';
              previewWrap?.classList.add('hidden');
              previewImg?.removeAttribute('src');
              return;
            }
            label.textContent = f.name;
        
            if (f.type.startsWith('image/')) {
              const url = URL.createObjectURL(f);
              if (previewImg) previewImg.src = url;
              previewWrap?.classList.remove('hidden');
            } else {
              previewWrap?.classList.add('hidden');
              previewImg?.removeAttribute('src');
            }
          }, { passive: true });
        });
    </script>
    
    <style>
        .input-hidden{
          position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;
          clip:rect(0,0,0,0);white-space:nowrap;border:0;
        }
    </style>
}
